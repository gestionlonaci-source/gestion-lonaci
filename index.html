<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LONACI Expert - Syst√®me Int√©gral</title>
    <style>
        :root{ --primary:#1e40af; --bg:#f1f5f9; --success:#059669; --warning:#7c3aed; --danger:#dc2626; }
        body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:#333}
        header{background:var(--primary);color:#fff;padding:1rem;text-align:center;font-weight:bold}
        nav{display:flex;gap:.5rem;padding:.5rem;background:#e5e7eb;overflow-x:auto}
        nav button{flex:1;padding:.6rem;border:none;border-radius:6px;cursor:pointer;font-weight:bold;min-width:100px;background:#d1d5db}
        nav button.active{background:var(--primary);color:white}
        section{display:none;padding:1rem;max-width:1000px;margin:auto}
        section.active{display:block}
        .card{background:white;padding:1.2rem;border-radius:10px;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        h3{margin:0 0 1rem 0;border-left:4px solid var(--primary);padding-left:10px;font-size:1.1rem}
        input,select,button{width:100%;padding:0.7rem;margin-top:0.5rem;border:1px solid #cbd5e1;border-radius:8px;box-sizing:border-box}
        button{cursor:pointer;font-weight:bold}
        .btn-save{background:var(--success);color:white;border:none}
        table{width:100%;border-collapse:collapse;margin-top:1rem;background:white}
        th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:center;font-size:0.85rem}
        th{background:#f8fafc; color:var(--primary)}
        .stat-grid{display:flex; gap:10px; margin-bottom:1rem}
        .stat-box{background:white;padding:1rem;border-radius:10px;text-align:center;border:1px solid #e2e8f0;flex:1}
        .stat-box b{display:block;font-size:1.1rem;margin-top:5px}
        .delete{color:var(--danger);cursor:pointer;font-weight:bold}
        .total-row{background:#f1f5f9; font-weight:bold}
    </style>
</head>
<body>

<header>LONACI - GESTION COMMERCIALE CLOUD</header>

<nav>
    <button class="active" onclick="tab('dash', this)">DASHBOARD</button>
    <button onclick="tab('ventes', this)">VENTES</button>
    <button onclick="tab('charges', this)">CHARGES</button>
    <button onclick="tab('bilan', this)">BILANS</button>
    <button onclick="tab('config', this)">‚öôÔ∏è CONFIG</button>
</nav>

<section id="dash" class="active">
    <div class="stat-grid">
        <div class="stat-box"><span>Recettes</span><b id="dashRecette">0 F</b></div>
        <div class="stat-box"><span>Commissions</span><b id="dashComm" style="color:var(--success)">0 F</b></div>
        <div class="stat-box"><span>Charges</span><b id="dashCharge" style="color:var(--danger)">0 F</b></div>
    </div>
    <div class="card" style="text-align:center; background:#1e293b; color:white">
        <small>B√âN√âFICE NET DU MOIS</small>
        <h2 id="dashNet" style="margin:10px 0 0 0; font-size:1.8rem">0 FCFA</h2>
    </div>
</section>

<section id="ventes">
    <div class="card">
        <h3>Nouvelle Vente</h3>
        <div style="display:flex; gap:10px">
            <input type="number" id="vDay" placeholder="Jour">
            <select id="vMonth"></select>
        </div>
        <select id="vService" onchange="updateAgentList()"></select>
        <select id="vAgent"></select>
        <input type="number" id="vAmount" placeholder="Montant Recette">
        <button class="btn-save" onclick="addVente()">ENREGISTRER</button>
    </div>
    <div class="card"><h3>Derni√®res saisies</h3><table id="tableVentes"></table></div>
</section>

<section id="charges">
    <div class="card">
        <h3>Saisir une Charge</h3>
        <select id="cCat"><option>Loyer</option><option>√âlectricit√©</option><option>Eau</option><option>Salaires</option><option>Autres</option></select>
        <input type="number" id="cAmount" placeholder="Montant"><input type="date" id="cDate">
        <button style="background:var(--danger);color:white;border:none" onclick="addCharge()">AJOUTER</button>
    </div>
    <div class="card"><table id="tableCharges"></table></div>
</section>

<section id="bilan">
    <div class="card">
        <h3>G√©n√©rer Bilan Mensuel</h3>
        <select id="bMonth"></select>
        <button class="btn-save" style="background:var(--primary)" onclick="generateReport()">AFFICHER LE BILAN D√âTAILL√â</button>
    </div>
    <div id="reportArea"></div>
</section>

<section id="config">
    <div class="card" style="border: 2px solid var(--success)">
        <h3>‚òÅÔ∏è Synchronisation par Mail (Google)</h3>
        <button style="background:var(--primary);color:white;border:none" onclick="handleAuth()">1. Connexion Compte Google</button>
        <div id="cloudBtns" style="display:none; flex-direction:column; gap:8px; margin-top:10px">
            <button class="btn-save" onclick="saveToDrive()">üì§ Sauvegarder sur Drive</button>
            <button style="background:var(--warning);color:white;border:none" onclick="loadFromDrive()">üì• Restaurer depuis Drive</button>
        </div>
    </div>

    <div class="card">
        <h3>Services & Taux</h3>
        <input id="sName" placeholder="Nom service"><input type="number" id="sRate" placeholder="Taux %">
        <button class="btn-save" onclick="addService()">Ajouter</button>
        <table id="tableServices"></table>
    </div>

    <div class="card">
        <h3>Gestion des Agents</h3>
        <input id="aCode" placeholder="Code Agent"><input id="aName" placeholder="Nom Complet">
        <select id="aService" onchange="showRateInfo()"></select>
        <p id="rateInfo" style="color:var(--primary); font-weight:bold; font-size:0.8rem">Taux: -</p>
        <button class="btn-save" onclick="addAgent()">Ajouter Agent</button>
        <table id="tableAgents"></table>
    </div>
</section>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
let db = JSON.parse(localStorage.getItem('lonaci_cloud_v1')) || { services: [], agents: [], ventes: [], charges: [] };
const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];

function save() { localStorage.setItem('lonaci_cloud_v1', JSON.stringify(db)); render(); }
function tab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

// CONFIGURATION
function addService() {
    const n = document.getElementById('sName').value; const r = document.getElementById('sRate').value;
    if(n && r) { db.services.push({ name: n, rate: parseFloat(r)/100 }); save(); }
}
function addAgent() {
    const c = document.getElementById('aCode').value; const n = document.getElementById('aName').value;
    const sn = document.getElementById('aService').value;
    if(!c || !n || !sn) return alert("Champs incomplets");
    const s = db.services.find(x => x.name === sn);
    db.agents.push({ code: c, name: n, service: sn, rate: s.rate });
    save(); alert("Agent ajout√© !");
}
function showRateInfo() {
    const s = db.services.find(x => x.name === document.getElementById('aService').value);
    document.getElementById('rateInfo').textContent = s ? `Taux : ${s.rate * 100}%` : "Taux : -";
}

// VENTES & CHARGES
function updateAgentList() {
    const sn = document.getElementById('vService').value;
    const filtered = db.agents.filter(a => a.service === sn);
    document.getElementById('vAgent').innerHTML = filtered.map(a => `<option value="${a.code}">${a.name}</option>`).join("");
}
function addVente() {
    const ac = document.getElementById('vAgent').value; const am = parseFloat(document.getElementById('vAmount').value);
    const agent = db.agents.find(a => a.code === ac);
    if(!agent || isNaN(am)) return alert("Veuillez remplir le montant");
    db.ventes.push({
        date: `${document.getElementById('vDay').value || new Date().getDate()}/${Number(document.getElementById('vMonth').value)+1}/2026`,
        agent: agent.name, service: agent.service, amount: am, commission: am * agent.rate
    });
    document.getElementById('vAmount').value = ""; save();
}
function addCharge() {
    const am = parseFloat(document.getElementById('cAmount').value); const dt = document.getElementById('cDate').value;
    if(isNaN(am) || !dt) return alert("Date et montant requis");
    db.charges.push({ date: dt, cat: document.getElementById('cCat').value, amount: am });
    document.getElementById('cAmount').value = ""; save();
}

// BILAN D√âTAILL√â
function generateReport() {
    const mIdx = Number(document.getElementById('bMonth').value);
    const filtered = db.ventes.filter(v => v.date.includes(`/${mIdx+1}/2026`));
    if(filtered.length === 0) { document.getElementById('reportArea').innerHTML = "<p>Aucune donn√©e.</p>"; return; }
    
    let tv = 0, tc = 0;
    let html = `<div class="card"><h3>Bilan ${months[mIdx]}</h3><table><tr><th>Date</th><th>Agent</th><th>Vente</th><th>Comm.</th></tr>`;
    filtered.forEach(v => {
        tv += v.amount; tc += v.commission;
        html += `<tr><td>${v.date}</td><td>${v.agent}</td><td>${v.amount.toLocaleString()}</td><td>${v.commission.toLocaleString()}</td></tr>`;
    });
    html += `<tr class="total-row"><td colspan="2">TOTAL</td><td>${tv.toLocaleString()} F</td><td>${tc.toLocaleString()} F</td></tr></table></div>`;
    document.getElementById('reportArea').innerHTML = html;
}

// CLOUD DRIVE (SYNC PAR MAIL)
const CLIENT_ID = '642215240533-ko9t9ulmq5igcqv3csuhvuaptkmc96nt.apps.googleusercontent.com';
let tokenClient;
function gapiLoaded() { gapi.load('client', () => gapi.client.init({apiKey: 'AIzaSyBMjWoe9Y3WnTLPbh3nqSxoG799Tj9tu9M', discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]})); }
function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.file', callback: (t) => { if(t) document.getElementById('cloudBtns').style.display='flex'; }}); }
function handleAuth() { tokenClient.requestAccessToken(); }
async function saveToDrive() {
    const metadata = { name: 'lonaci_db.json', mimeType: 'application/json' };
    const file = new Blob([JSON.stringify(db)], {type: 'application/json'});
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    form.append('file', file);
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: 'Bearer ' + gapi.client.getToken().access_token }, body: form });
    alert("‚úÖ Sauvegarde effectu√©e !");
}
async function loadFromDrive() {
    const response = await gapi.client.drive.files.list({ q: "name='lonaci_db.json'", fields: 'files(id)' });
    if (response.result.files.length > 0) {
        const res = await gapi.client.drive.files.get({ fileId: response.result.files[0].id, alt: 'media' });
        if(confirm("Importer les donn√©es du cloud ?")) { db = res.result; save(); }
    }
}

function render() {
    const sOpts = db.services.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
    document.getElementById('vService').innerHTML = sOpts; document.getElementById('aService').innerHTML = sOpts;
    const mOpts = months.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
    document.getElementById('vMonth').innerHTML = mOpts; document.getElementById('bMonth').innerHTML = mOpts;

    document.getElementById('tableServices').innerHTML = `<tr><th>Service</th><th>Taux</th></tr>` + db.services.map(s=>`<tr><td>${s.name}</td><td>${s.rate*100}%</td></tr>`).join("");
    document.getElementById('tableAgents').innerHTML = `<tr><th>Code</th><th>Nom</th></tr>` + db.agents.map(a=>`<tr><td>${a.code}</td><td>${a.name}</td></tr>`).join("");
    document.getElementById('tableVentes').innerHTML = `<tr><th>Agent</th><th>Recette</th></tr>` + db.ventes.slice(-5).reverse().map(v=>`<tr><td>${v.agent}</td><td>${v.amount.toLocaleString()}</td></tr>`).join("");
    document.getElementById('tableCharges').innerHTML = `<tr><th>Date</th><th>Montant</th></tr>` + db.charges.slice(-5).reverse().map(c=>`<tr><td>${c.date}</td><td>${c.amount.toLocaleString()}</td></tr>`).join("");

    const m = new Date().getMonth() + 1;
    const curV = db.ventes.filter(v => v.date.includes(`/${m}/2026`));
    const curC = db.charges.filter(c => c.date.includes(`-0${m}-`) || c.date.includes(`-${m}-`));
    const tR = curV.reduce((s,v)=>s+v.amount,0); const tCo = curV.reduce((s,v)=>s+v.commission,0); const tCh = curC.reduce((s,c)=>s+c.amount,0);
    document.getElementById('dashRecette').textContent = tR.toLocaleString() + " F";
    document.getElementById('dashComm').textContent = tCo.toLocaleString() + " F";
    document.getElementById('dashCharge').textContent = tCh.toLocaleString() + " F";
    document.getElementById('dashNet').textContent = (tCo - tCh).toLocaleString() + " FCFA";
    updateAgentList();
}
render();
</script>
</body>
</html>